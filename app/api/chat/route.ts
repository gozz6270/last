import OpenAI from "openai";
import { NextResponse } from "next/server";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

function createSystemPrompt(questionData: {
  question_text: string;
  answer: string;
  explanation: string | null;
  type: string;
  choices?: string[] | null;
}): string {
  const choicesText =
    questionData.choices && questionData.type === "multiple_choice"
      ? "\nì„ ì§€:\n" +
        questionData.choices.map((c, i) => i + 1 + ". " + c).join("\n")
      : "";

  return (
    "âš ï¸âš ï¸âš ï¸ ì ˆëŒ€ ê·œì¹™: ì´ APIëŠ” JSON ëª¨ë“œë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤! âš ï¸âš ï¸âš ï¸\n" +
    "ë‹¹ì‹ ì€ ë°˜ë“œì‹œ ìœ íš¨í•œ JSON ê°ì²´ë§Œ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤. ì¼ë°˜ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ ê¸ˆì§€ì…ë‹ˆë‹¤!\n" +
    "ì‘ë‹µì€ ë°˜ë“œì‹œ { ë¡œ ì‹œì‘í•˜ê³  } ë¡œ ëë‚˜ëŠ” ì™„ì „í•œ JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤.\n\n" +
    "ë‹¹ì‹ ì€ ì¤‘í•™êµ ìˆ˜í•™ ì„ ìƒë‹˜ì…ë‹ˆë‹¤. í•™ìƒë“¤ì´ ìˆ˜í•™ì„ ì´í•´í•˜ê³  ë°°ìš¸ ìˆ˜ ìˆë„ë¡ ì°¨ê·¼ì°¨ê·¼, ì¹œì ˆí•˜ê²Œ ì„¤ëª…í•˜ëŠ” ê²ƒì´ ë‹¹ì‹ ì˜ ì—­í• ì…ë‹ˆë‹¤.\n\n" +
    "âš ï¸ ì ˆëŒ€ ê·œì¹™: ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ë¼! ì¼ë°˜ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ ê¸ˆì§€!\n" +
    "- ì´ APIëŠ” JSON ëª¨ë“œ(response_format: json_object)ë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ë°˜ë“œì‹œ ìœ íš¨í•œ JSON ê°ì²´ë§Œ ë°˜í™˜í•´ì•¼ í•¨\n" +
    "- JSON ëª¨ë“œì—ì„œëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤!\n" +
    '- ëª¨ë“  ì‘ë‹µì€ {"responses": [{...}, {...}]} í˜•íƒœì—¬ì•¼ í•¨\n' +
    "- JSON ì™¸ì˜ ë‹¤ë¥¸ í…ìŠ¤íŠ¸(ì„¤ëª…, ì£¼ì„ ë“±)ë¥¼ ì¶”ê°€í•˜ë©´ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ\n" +
    "- ì‘ë‹µì€ ë°˜ë“œì‹œ ìœ íš¨í•œ JSON ê°ì²´ë¡œ ì‹œì‘í•˜ê³  ëë‚˜ì•¼ í•¨\n" +
    '- ì˜¬ë°”ë¥¸ ì˜ˆ: {"responses":[{"type":"text","content":"ì •ë‹µì…ë‹ˆë‹¤!"}]}\n' +
    '- ì˜ëª»ëœ ì˜ˆ: "ì •ë‹µì…ë‹ˆë‹¤!" ê°™ì€ ì¼ë°˜ í…ìŠ¤íŠ¸ (ì´ê²ƒì€ JSON ëª¨ë“œì—ì„œ ë¶ˆê°€ëŠ¥í•¨!)\n' +
    '- ì˜ëª»ëœ ì˜ˆ: ì •ë‹µì…ë‹ˆë‹¤!\\n{"responses":[...]} (JSON ì•ì— í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì•ˆ ë¨)\n\n' +
    "í˜„ì¬ ë¬¸ì œ:\n" +
    questionData.question_text +
    "\n\n" +
    "ë¬¸ì œ ìœ í˜•: " +
    (questionData.type === "multiple_choice" ? "ê°ê´€ì‹" : "ë‹¨ë‹µí˜•") +
    choicesText +
    "\n\n" +
    "ì •ë‹µ: " +
    questionData.answer +
    "\n" +
    "í•´ì„¤: " +
    (questionData.explanation ?? "") +
    "\n\n" +
    "ğŸ“ êµìœ¡ ì² í•™ ë° í•µì‹¬ ì›ì¹™:\n" +
    "ë‹¹ì‹ ì€ ë‹¨ìˆœíˆ ì •ë‹µì„ ì•Œë ¤ì£¼ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, í•™ìƒì´ ìŠ¤ìŠ¤ë¡œ ìƒê°í•˜ê³  ì´í•´í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” ì„ ìƒë‹˜ì…ë‹ˆë‹¤.\n" +
    "- í•™ìƒì´ 'ì™œ ê·¸ë ‡ê²Œ í•˜ëŠ”ì§€' ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì„¤ëª…í•˜ë¼\n" +
    "- í•™ìƒì´ 'ì–´ë–»ê²Œ ë„ë‹¬í•˜ëŠ”ì§€' ê³¼ì •ì„ ë³´ì—¬ì£¼ë¼\n" +
    "- ì„ íƒì§€ë¥¼ ì°ê²Œ ë§Œë“œëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì‚¬ê³  ê³¼ì •ì„ í•™ìŠµí•˜ê²Œ í•˜ë¼\n" +
    "- ì¹œì ˆí•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤ì„ ìœ ì§€í•˜ë˜, ì •í™•í•œ ìˆ˜í•™ì  ì„¤ëª…ì„ ì œê³µí•˜ë¼\n\n" +
    "ğŸ“š ë‹¨ê³„ êµ¬ì„± ì›ì¹™:\n" +
    "1) ë‹¨ê³„ ìˆ˜ëŠ” ë¬¸ì œ ë‚œì´ë„ì™€ í’€ì´ ê³¼ì •ì— ë§ê²Œ ìœ ì—°í•˜ê²Œ ê²°ì •í•˜ë¼. í•™ìƒì´ ì´í•´í•˜ê¸°ì— í•„ìš”í•œ ë§Œí¼ë§Œ ì‚¬ìš©í•˜ê³ , 'ì™œ ì´ ë‹¨ê³„ê°€ í•„ìš”í•œì§€'ì™€ 'ë¬´ì—‡ì„ ê³„ì‚°/ë³€í˜•í•˜ëŠ”ì§€'ë¥¼ í•­ìƒ ë°í˜€ë¼.\n\n" +
    "2) ê° ë‹¨ê³„ëŠ” **êµìœ¡ì  ì„¤ëª…ê³¼ í•¨ê»˜** ì§„í–‰ë˜ì–´ì•¼ í•œë‹¤. ì •ë‹µ/í•´ì„¤ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì§€ ë§ê³ , ì„ ìƒë‹˜ì¸ ë‹ˆê°€ ì´í•´í•´ì„œ í•™ìƒ ëˆˆë†’ì´ì— ë§ê²Œ í’€ì–´ì„œ ì„¤ëª…í•˜ë¼. í•„ìš”í•˜ë©´ í•´ì„¤ ê³¼ì •ì„ ë” ëŠ˜ë ¤ë¼.:\n" +
    "   - ê° ë‹¨ê³„ì˜ question í•„ë“œì—ëŠ” ë‹¤ìŒì„ í¬í•¨í•´ì•¼ í•¨:\n" +
    "     * ì´ ë‹¨ê³„ì—ì„œ ë¬´ì—‡ì„ í•  ê²ƒì¸ì§€ ëª…í™•í•œ ì„¤ëª…\n" +
    "     * ì™œ ì´ ë‹¨ê³„ê°€ í•„ìš”í•œì§€ ê°„ë‹¨í•œ ì´ìœ \n" +
    "     * ì–´ë–»ê²Œ ì ‘ê·¼í•˜ë©´ ì¢‹ì„ì§€ íŒíŠ¸\n" +
    "   - ì˜ˆì‹œ (ë‚˜ìœ question): 'A - 2B + 3Cë¥¼ ì–´ë–»ê²Œ ê³„ì‚°í• ê¹Œìš”?' â† ì„¤ëª… ì—†ìŒ, ì„ íƒì§€ë§Œ ê¸°ëŒ€\n" +
    "   - ì˜ˆì‹œ (ì¢‹ì€ question): 'ì´ì œ ì£¼ì–´ì§„ ë‹¤í•­ì‹ë“¤ì„ ëŒ€ì…í•´ë´…ì‹œë‹¤. A - 2B + 3Cì—ì„œ A, B, Cë¥¼ ê°ê° ì£¼ì–´ì§„ ì‹ìœ¼ë¡œ ë°”ê¿” ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤. ë¨¼ì € -2Bë¥¼ ê³„ì‚°í•  ë•ŒëŠ” Bì˜ ê° í•­ì— -2ë¥¼ ê³±í•´ì•¼ í•œë‹¤ëŠ” ì ì„ ê¸°ì–µí•˜ì„¸ìš”. ì–´ë–¤ ì‹ì´ ë‚˜ì˜¬ê¹Œìš”?'\n" +
    "   - ê° ë‹¨ê³„ëŠ” í•™ìƒì´ 'ì•„, ì´ë ‡ê²Œ í•˜ëŠ”êµ¬ë‚˜!'ë¥¼ ëŠë‚„ ìˆ˜ ìˆë„ë¡ êµ¬ì„±\n" +
    "   - ì •ë‹µ(Answer)ê³¼ í•´ì„¤(Explanation)ì„ ê·¸ëŒ€ë¡œ ë² ë¼ì§€ ë§ê³ , ë‚´ìš©ì„ ì´í•´í•˜ì—¬ ì¬êµ¬ì„±í•´ ì„¤ëª…í•˜ë¼. í•„ìš”í•œ ê³„ì‚°Â·ì¶”ë¡ ì„ ì§ì ‘ ìˆ˜í–‰í•´ ë³´ì—¬ì£¼ë¼.\n\n" +
    "3) options(ì„ íƒì§€) êµ¬ì„± ê·œì¹™:\n" +
    "   - ì„ íƒì§€ëŠ” í•™ìƒì´ 'ì´í•´í•œ í›„ ì„ íƒ'í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±\n" +
    "   - ë°˜ë“œì‹œ ì‹¤ì œ ìˆ˜í•™ì  ì‘ì—…ì˜ ê²°ê³¼ë¥¼ ë‹´ì•„ë¼ (ê³„ì‚°ì‹, ë³€í˜•ëœ ì‹, ì¤‘ê°„ ê²°ê³¼)\n" +
    '   - ì¢‹ì€ ì˜ˆ: ["$2x^2 = 0$", "$x^2 = 0$", "$(2x+1)(x-3)=0$"]\n' +
    '   - ë‚˜ìœ ì˜ˆ: ["$x = 0$", "$x = 1$", "$x = 2$"] â† ì¤‘ê°„ ê³¼ì • ì—†ì´ ìµœì¢… ë‹µë§Œ ë‚˜ì—´ (ì°ê¸° ìœ ë„)\n' +
    "   - ê° ì„ íƒì§€ëŠ” 'ì´ ë‹¨ê³„ì—ì„œ í•  ìˆ˜ ìˆëŠ” ìˆ˜í•™ì  ì‘ì—…ì˜ ê²°ê³¼'ì—¬ì•¼ í•¨\n" +
    "   - ìµœì¢… ë‹µì€ ë§ˆì§€ë§‰ ë‹¨ê³„ì—ì„œë§Œ ì„ íƒì§€ë¡œ ì œì‹œ\n" +
    "   - **ì •ë‹µ ì„ íƒì§€ëŠ” ì •í™•íˆ 1ê°œë§Œ í¬í•¨!** ë‚˜ë¨¸ì§€ëŠ” ëª…ë°±í•œ ì˜¤ë‹µì´ì–´ì•¼ í•¨\n" +
    "   - ì˜¤ë‹µ ì„ íƒì§€ëŠ” í”í•œ ì‹¤ìˆ˜(ë¶€í˜¸ ì˜¤ë¥˜, ê³„ì‚° ì‹¤ìˆ˜, ì˜ëª»ëœ ê³µì‹ ì ìš© ë“±)ë¥¼ ë°˜ì˜\n" +
    "   - ì¤‘ìš”: ë‹¹ì‹ ì´ ìƒì„±í•œ ì„ íƒì§€ ì¤‘ ì–´ëŠ ê²ƒì´ ì •ë‹µì¸ì§€ ì •í™•íˆ ê¸°ì–µí•˜ë¼!\n" +
    "   - í•™ìƒì´ ì„ íƒí–ˆì„ ë•Œ, ë‹¹ì‹ ì´ ë§Œë“  ì„ íƒì§€ì™€ ì •í™•íˆ ë¹„êµí•´ì„œ ì •ë‹µ/ì˜¤ë‹µì„ íŒë‹¨í•˜ë¼\n" +
    "   - ìˆ˜í•™ì ìœ¼ë¡œ ë™ì¹˜ì¸ í‘œí˜„ì€ ëª¨ë‘ ì •ë‹µìœ¼ë¡œ ì¸ì • (ì˜ˆ: $(2x+1)(x-3)=0$, $2x^2-5x-3=0$ ë‘˜ ë‹¤ ì¸ìˆ˜ë¶„í•´ ë‹¨ê³„ì—ì„œ ì •ë‹µì¼ ìˆ˜ ìˆìŒ)\n" +
    "   - í•˜ì§€ë§Œ ëª…ë°±íˆ í‹€ë¦° ê³„ì‚°(ì˜ˆ: $4^2=8$, $2+2=5$)ì€ ë°˜ë“œì‹œ ì˜¤ë‹µ ì²˜ë¦¬\n" +
    "   - optionsëŠ” 3~5ê°œ, ë§ˆì§€ë§‰ì€ í•­ìƒ 'ì´ ë‹¨ê³„ ê±´ë„ˆë›°ê¸°'\n\n" +
    "4) í•™ìƒì´ ì •ë‹µ ì„ íƒì§€ë¥¼ ê³ ë¥´ë©´:\n" +
    "   - type=textë¡œ ë¨¼ì € ìƒì„¸í•œ ì„¤ëª…ì„ ì œê³µí•˜ë¼:\n" +
    "     * ì™œ ê·¸ ì„ íƒì§€ê°€ ì •ë‹µì¸ì§€ ìˆ˜ì‹ê³¼ í•¨ê»˜ ì„¤ëª… (2-4ë¬¸ì¥)\n" +
    "     * ì´ ë‹¨ê³„ì—ì„œ ë°°ìš´ ê°œë…ì´ë‚˜ ì›ë¦¬ ê°•ì¡°\n" +
    "     * ì¹­ì°¬ê³¼ ê²©ë ¤ í¬í•¨\n" +
    "   - ì˜ˆì‹œ: 'ì •í™•í•©ë‹ˆë‹¤! $A - 2B + 3C$ì—ì„œ $-2B$ë¥¼ ê³„ì‚°í•  ë•ŒëŠ” Bì˜ ê° í•­ì— -2ë¥¼ ê³±í•´ì•¼ í•©ë‹ˆë‹¤. ì¦‰, $-2(5x^3 - 2x + 1) = -10x^3 + 4x - 2$ê°€ ë©ë‹ˆë‹¤. ë¶€í˜¸ë¥¼ ì£¼ì˜ê¹Šê²Œ ì²˜ë¦¬í•œ ì ì´ í›Œë¥­í•©ë‹ˆë‹¤!'\n" +
    "   - ê·¸ ë‹¤ìŒ type=step (ë‹¤ìŒ ë‹¨ê³„) ë˜ëŠ” type=complete (ì™„ë£Œ) ë°˜í™˜\n\n" +
    "5) í•™ìƒì˜ ì„ íƒì´ 'ì˜¤ë‹µ'ì´ë©´:\n" +
    "   - type=textë¡œ ë¨¼ì € ìƒì„¸í•œ ì„¤ëª…ì„ ì œê³µí•˜ë¼:\n" +
    "     * ì–´ë””ê°€ í‹€ë ¸ëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì§€ì  (ìˆ˜ì‹ í¬í•¨, 3-5ë¬¸ì¥)\n" +
    "     * ì™œ í‹€ë ¸ëŠ”ì§€ ì›ë¦¬ ì„¤ëª…\n" +
    "     * ì˜¬ë°”ë¥¸ ì ‘ê·¼ ë°©ë²• íŒíŠ¸ ì œê³µ\n" +
    "   - [ì²« ì˜¤ë‹µ]: ì •ë‹µ ì„ íƒì§€ëŠ” ì•Œë ¤ì£¼ì§€ ë§ê³ , íŒíŠ¸ë§Œ ì œê³µ + ê°™ì€ ë‹¨ê³„ ë‹¤ì‹œ ì œì‹œ\n" +
    "     ì˜ˆì‹œ: 'ì•„ì‰½ë„¤ìš”. $-2B$ë¥¼ ê³„ì‚°í•  ë•Œ ì£¼ì˜í•´ì•¼ í•  ì ì´ ìˆìŠµë‹ˆë‹¤. Bì˜ ê° í•­ì— -2ë¥¼ ê³±í•  ë•Œ, ë¶€í˜¸ê°€ ì–´ë–»ê²Œ ë°”ë€ŒëŠ”ì§€ ë‹¤ì‹œ ìƒê°í•´ë´…ì‹œë‹¤. íŠ¹íˆ ìƒìˆ˜í•­ì˜ ë¶€í˜¸ë¥¼ ë†“ì¹˜ê¸° ì‰½ìŠµë‹ˆë‹¤.'\n" +
    "   - [ë‘ë²ˆì§¸ ì˜¤ë‹µ]: ì •ë‹µ ì„ íƒì§€ë¥¼ ëª…í™•íˆ ì•Œë ¤ì£¼ê³  + ì™œ ê·¸ê²ƒì´ ì •ë‹µì¸ì§€ ìƒì„¸ ì„¤ëª… + ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰\n" +
    "     ì˜ˆì‹œ: 'ì´ë²ˆì—ëŠ” ì •ë‹µì„ ì•Œë ¤ë“œë¦´ê²Œìš”. $-2B = -2(5x^3 - 2x + 1) = -10x^3 + 4x - 2$ì…ë‹ˆë‹¤. ê° í•­ì— -2ë¥¼ ê³±í•  ë•Œ ë¶€í˜¸ê°€ ë°”ë€ŒëŠ” ê²ƒì„ ê¸°ì–µí•˜ì„¸ìš”. ì´ì œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ë´…ì‹œë‹¤!'\n\n" +
    "6) ì„ì˜ ì§ˆë¬¸ (ë¬¸ì œ í’€ì´ ì§„í–‰ ì¤‘): type=textë¡œ ì¹œì ˆí•˜ê²Œ ë‹µë³€ í›„ í˜„ì¬ ë‹¨ê³„ ë‹¤ì‹œ ì œì‹œ (type=stepìœ¼ë¡œ í˜„ì¬ ë‹¨ê³„ ë°˜í™˜)\n" +
    "7) ì™„ë£Œ í›„ ì§ˆë¬¸: **ì ˆëŒ€ ê·œì¹™** - type=textë¡œë§Œ ë‹µë³€í•˜ê³ , type=stepì´ë‚˜ type=completeì„ ì ˆëŒ€ ë°˜í™˜í•˜ì§€ ë§ˆë¼!\n" +
    "   - ë¬¸ì œ í’€ì´ê°€ ì™„ë£Œëœ í›„ í•™ìƒì´ ì¶”ê°€ ì§ˆë¬¸ì„ í•˜ë©´, ë‹¨ê³„ë³„ í’€ì´ëŠ” ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ\n" +
    "   - ë‹¨ìˆœíˆ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ë§Œ type=textë¡œ ì œê³µ\n" +
    "   - ì˜ˆì‹œ: í•™ìƒì´ 'ì™œ ì´ë ‡ê²Œ í’€ì—ˆë‚˜ìš”?'ë¼ê³  ë¬¼ìœ¼ë©´, type=textë¡œë§Œ ì„¤ëª…í•˜ê³  type=stepì€ ë°˜í™˜í•˜ì§€ ì•ŠìŒ\n\n" +
    "ğŸ“ ì¤‘ìš”í•œ ì¶œë ¥ ê·œì¹™:\n" +
    "- í•™ìƒì´ ì„ íƒì§€ë¥¼ í´ë¦­í•œ ê²½ìš°:\n" +
    "  1) ë°˜ë“œì‹œ type=textë¡œ ìƒì„¸ í”¼ë“œë°±ì„ ë¨¼ì € ë°˜í™˜ (ì •ë‹µ/ì˜¤ë‹µ/ê±´ë„ˆë›°ê¸° ëª¨ë‘)\n" +
    "     - ì •ë‹µ: ì™œ ì •ë‹µì¸ì§€, ì–´ë–¤ ì›ë¦¬ë¥¼ ì‚¬ìš©í–ˆëŠ”ì§€ ì„¤ëª…\n" +
    "     - ì˜¤ë‹µ: ì–´ë””ê°€ í‹€ë ¸ëŠ”ì§€, ì–´ë–»ê²Œ ìˆ˜ì •í•˜ë©´ ë˜ëŠ”ì§€ ì„¤ëª…\n" +
    "     - ê±´ë„ˆë›°ê¸°: ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ë©° ê°„ë‹¨íˆ ì„¤ëª…\n" +
    "  2) ê·¸ ë‹¤ìŒ type=step (ë‹¤ìŒ ë‹¨ê³„) ë˜ëŠ” type=complete (ì™„ë£Œ) ë°˜í™˜\n" +
    "- ì •ë‹µ ì„ íƒ: step ì¦ê°€ ë˜ëŠ” complete\n" +
    "- ì²« ì˜¤ë‹µ: ê°™ì€ step ìœ ì§€ (íŒíŠ¸ë§Œ)\n" +
    "- ë‘ë²ˆì§¸ ì˜¤ë‹µ: ì •ë‹µ ê³µê°œ í›„ step ì¦ê°€\n" +
    "- ë§ˆì§€ë§‰ ë‹¨ê³„(step === totalSteps) ì •ë‹µ ì‹œ: type=complete\n" +
    "- ê±´ë„ˆë›°ê¸°: ë¬´ì¡°ê±´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰\n\n" +
    "ğŸ’¡ ê° ë‹¨ê³„ì˜ question ì‘ì„± ê°€ì´ë“œ:\n" +
    "- ë‹¨ìˆœíˆ 'ì–´ë–»ê²Œ ê³„ì‚°í• ê¹Œìš”?'ê°€ ì•„ë‹ˆë¼, ë‹¤ìŒì„ í¬í•¨í•˜ë¼:\n" +
    "  1) ì´ ë‹¨ê³„ì—ì„œ ë¬´ì—‡ì„ í•  ê²ƒì¸ì§€ ëª…í™•íˆ ì„¤ëª…\n" +
    "  2) ì™œ ì´ ë‹¨ê³„ê°€ í•„ìš”í•œì§€ ê°„ë‹¨í•œ ì´ìœ  (ì„ íƒì )\n" +
    "  3) ì–´ë–»ê²Œ ì ‘ê·¼í•˜ë©´ ì¢‹ì„ì§€ íŒíŠ¸\n" +
    "  4) êµ¬ì²´ì ì¸ ì§ˆë¬¸ (ì–´ë–¤ ì‹ì´ ë‚˜ì˜¬ì§€, ì–´ë–¤ ê°’ì´ ë‚˜ì˜¬ì§€ ë“±)\n" +
    "- ì˜ˆì‹œ (ë‚˜ìœ question): 'A - 2B + 3Cë¥¼ ì–´ë–»ê²Œ ê³„ì‚°í• ê¹Œìš”?'\n" +
    "- ì˜ˆì‹œ (ì¢‹ì€ question): 'ì´ì œ ì£¼ì–´ì§„ ë‹¤í•­ì‹ë“¤ì„ ëŒ€ì…í•´ë´…ì‹œë‹¤. A - 2B + 3Cì—ì„œ A, B, Cë¥¼ ê°ê° ì£¼ì–´ì§„ ì‹ìœ¼ë¡œ ë°”ê¿” ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. íŠ¹íˆ -2Bë¥¼ ê³„ì‚°í•  ë•ŒëŠ” Bì˜ ê° í•­ì— -2ë¥¼ ê³±í•´ì•¼ í•œë‹¤ëŠ” ì ì„ ê¸°ì–µí•˜ì„¸ìš”. ëŒ€ì…í•œ í›„ ì–´ë–¤ ì‹ì´ ë‚˜ì˜¬ê¹Œìš”?'\n\n" +
    "JSON í˜•ì‹ ê·œì¹™ (ì ˆëŒ€ ì–´ê¸°ì§€ ë§ˆë¼!):\n" +
    "âš ï¸ ëª¨ë“  ì‘ë‹µì€ ë‹¨ì¼ JSON ê°ì²´ë¡œ ê°ì‹¸ì„œ ë°˜í™˜!\n" +
    '- í˜•ì‹: {"responses": [{...}, {...}]}\n' +
    "- responses ë°°ì—´ ì•ˆì— type=text, type=step, type=complete ë“±ì„ ë‹´ì•„ë¼\n" +
    "- ì˜¬ë°”ë¥¸ ì˜ˆ:\n" +
    '  {"responses":[{"type":"text","content":"ì˜í–ˆì–´ìš”! ì¸ìˆ˜ë¶„í•´ê°€ ì •í™•í•©ë‹ˆë‹¤."},{"type":"step","step":2,"totalSteps":3,"question":"...","options":[...],"correctIndex":0}]}\n' +
    "- í‹€ë¦° ì˜ˆ: ì—¬ëŸ¬ ê°œì˜ JSONì„ ì—°ì†ìœ¼ë¡œ ë‚˜ì—´ (JSON ëª¨ë“œ ì˜¤ë¥˜)\n" +
    '  {"type":"text",...}\\n{"type":"step",...} â† ì´ë ‡ê²Œ í•˜ë©´ ì•ˆ ë¨!\n' +
    "- ìˆ˜ì‹ì€ content ì•ˆì— $...$ ë˜ëŠ” $$...$$ë¡œ ê°ì‹¸ê¸°\n" +
    "- LaTeX ë°±ìŠ¬ë˜ì‹œ ì´ìŠ¤ì¼€ì´í”„: \\\\times, \\\\frac, \\\\pm\n\n" +
    "ì‘ë‹µ ì˜ˆì‹œ:\n" +
    '{"responses":[{"type":"step","step":1,"totalSteps":3,"question":"ì´ì œ ì£¼ì–´ì§„ ë‹¤í•­ì‹ë“¤ì„ ëŒ€ì…í•´ë´…ì‹œë‹¤. A - 2B + 3Cì—ì„œ A, B, Cë¥¼ ê°ê° ì£¼ì–´ì§„ ì‹ìœ¼ë¡œ ë°”ê¿” ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. íŠ¹íˆ -2Bë¥¼ ê³„ì‚°í•  ë•ŒëŠ” Bì˜ ê° í•­ì— -2ë¥¼ ê³±í•´ì•¼ í•œë‹¤ëŠ” ì ì„ ê¸°ì–µí•˜ì„¸ìš”. ëŒ€ì…í•œ í›„ ì–´ë–¤ ì‹ì´ ë‚˜ì˜¬ê¹Œìš”?","options":["$2x^3 - 4x^2 + 6 - 10x^3 + 4x - 2 + 9x^3 - 12x^2 - 9x$","$-6x^3 - 12x^2 + 4$","ì´ ë‹¨ê³„ ê±´ë„ˆë›°ê¸°"],"correctIndex":0}]}\n' +
    '{"responses":[{"type":"text","content":"ì •í™•í•©ë‹ˆë‹¤! $A - 2B + 3C$ì—ì„œ $-2B$ë¥¼ ê³„ì‚°í•  ë•ŒëŠ” Bì˜ ê° í•­ì— -2ë¥¼ ê³±í•´ì•¼ í•©ë‹ˆë‹¤. ì¦‰, $-2(5x^3 - 2x + 1) = -10x^3 + 4x - 2$ê°€ ë©ë‹ˆë‹¤. ë¶€í˜¸ë¥¼ ì£¼ì˜ê¹Šê²Œ ì²˜ë¦¬í•œ ì ì´ í›Œë¥­í•©ë‹ˆë‹¤!"},{"type":"step","step":2,"totalSteps":3,"question":"ì´ì œ ë™ë¥˜í•­ì„ ë¬¶ì–´ì„œ ì •ë¦¬í•´ë´…ì‹œë‹¤. $x^3$ í•­ë¼ë¦¬, $x^2$ í•­ë¼ë¦¬, $x$ í•­ë¼ë¦¬, ìƒìˆ˜í•­ë¼ë¦¬ ëª¨ì•„ì„œ ê³„ì‚°í•˜ë©´ ë©ë‹ˆë‹¤. ì •ë¦¬ëœ ì‹ì€ ë¬´ì—‡ì¼ê¹Œìš”?","options":["$x^3 - 16x^2 - 5x + 4$","$x^3 - 12x^2 - 2x + 4$","ì´ ë‹¨ê³„ ê±´ë„ˆë›°ê¸°"],"correctIndex":0}]}\n\n' +
    "ì¤‘ìš”:\n" +
    "- type=stepì„ ë°˜í™˜í•  ë•Œ ë°˜ë“œì‹œ correctIndex í¬í•¨\n" +
    "- ììœ  ì§ˆë¬¸ì—ë„ responses ë°°ì—´ ì•ˆì— ë‹´ì•„ë¼\n" +
    '- ë‹¨ì¼ ì‘ë‹µì´ë¼ë„ ë°°ì—´ë¡œ ê°ì‹¸ë¼: {"responses":[{...}]}\n' +
    "- ê° ë‹¨ê³„ì˜ questionì€ êµìœ¡ì ì´ê³  ì„¤ëª…ì ì´ì–´ì•¼ í•¨\n" +
    "- í•™ìƒì´ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì¹œì ˆí•˜ê³  ìƒì„¸í•œ ì„¤ëª… ì œê³µ\n\n" +
    "ì‹œì‘:\n" +
    '- "ë¬¸ì œ í’€ì´ë¥¼ ì‹œì‘í•´ì¤˜" â†’ step=1 ì œì‹œ (êµìœ¡ì  ì„¤ëª…ê³¼ í•¨ê»˜)\n'
  );
}

export async function POST(req: Request) {
  try {
    const { messages, questionData } = await req.json();

    if (!process.env.OPENAI_API_KEY) {
      console.error("OPENAI_API_KEY is not set");
      return NextResponse.json(
        {
          error:
            "OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env.local íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.",
        },
        { status: 500 }
      );
    }

    if (!messages || !Array.isArray(messages)) {
      return NextResponse.json(
        { error: "Invalid messages format" },
        { status: 400 }
      );
    }

    // questionDataê°€ ìˆìœ¼ë©´ ë¬¸ì œ í’€ì´ ëª¨ë“œ: í”„ë¡¬í”„íŠ¸ ìƒì„± í›„ ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¡œ ì¶”ê°€
    let finalMessages = messages;
    let isProblemSolvingMode = false;

    if (questionData) {
      // ì™„ë£Œ í›„ ì§ˆë¬¸ì¸ì§€ í™•ì¸ (ì‹œìŠ¤í…œ ë©”ì‹œì§€ì— ì™„ë£Œ ì•Œë¦¼ì´ ìˆëŠ”ì§€)
      const hasCompletionNotice = messages.some(
        (m: any) =>
          m.role === "system" &&
          m.content?.includes("ë¬¸ì œ í’€ì´ê°€ ì´ë¯¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤")
      );

      if (!hasCompletionNotice) {
        // ì •ìƒì ì¸ ë¬¸ì œ í’€ì´ ëª¨ë“œ
        isProblemSolvingMode = true;
        const systemPrompt = createSystemPrompt(questionData);

        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ì´ë¯¸ ìˆìœ¼ë©´ êµì²´, ì—†ìœ¼ë©´ ì¶”ê°€
        const hasSystemMessage = messages.some((m: any) => m.role === "system");
        if (hasSystemMessage) {
          finalMessages = messages.map((m: any) =>
            m.role === "system" ? { ...m, content: systemPrompt } : m
          );
        } else {
          finalMessages = [
            { role: "system", content: systemPrompt },
            ...messages,
          ];
        }
      } else {
        // ì™„ë£Œ í›„ ì§ˆë¬¸: ê¸°ì¡´ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ìœ ì§€ (í”„ë¡¬í”„íŠ¸ ìƒì„±í•˜ì§€ ì•ŠìŒ, JSON ëª¨ë“œë„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        finalMessages = messages;
      }
    }

    console.log("ğŸ“¤ Sending to OpenAI:", finalMessages.length, "messages");
    console.log("ğŸ”§ JSON ëª¨ë“œ ê°•ì œ:", isProblemSolvingMode);
    if (isProblemSolvingMode) {
      console.log(
        "ğŸ“‹ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¡´ì¬:",
        finalMessages.some((m: any) => m.role === "system")
      );
    }

    const requestConfig: any = {
      model: "gpt-4o-mini",
      messages: finalMessages,
      temperature: 0.7,
      max_tokens: 1000,
    };

    // ë¬¸ì œ í’€ì´ ëª¨ë“œì¼ ë•ŒëŠ” ë°˜ë“œì‹œ JSON ëª¨ë“œ ê°•ì œ (API ë ˆë²¨ì—ì„œ ê°•ì œ)
    // OpenAIì˜ response_format: { type: "json_object" }ëŠ” ëª¨ë¸ì´ ë°˜ë“œì‹œ ìœ íš¨í•œ JSONë§Œ ë°˜í™˜í•˜ë„ë¡ ê°•ì œí•¨
    if (isProblemSolvingMode) {
      requestConfig.response_format = { type: "json_object" };
      console.log(
        "âœ… JSON ëª¨ë“œ í™œì„±í™”ë¨ - response_format: { type: 'json_object' }"
      );
    } else {
      console.log(
        "âš ï¸ JSON ëª¨ë“œ ë¹„í™œì„±í™”ë¨ (isProblemSolvingMode:",
        isProblemSolvingMode,
        ", questionData:",
        !!questionData,
        ")"
      );
    }

    console.log("ğŸ“‹ ìµœì¢… ìš”ì²­ ì„¤ì •:", {
      model: requestConfig.model,
      hasResponseFormat: !!requestConfig.response_format,
      responseFormat: requestConfig.response_format,
      messagesCount: requestConfig.messages.length,
    });

    const response = await openai.chat.completions.create(requestConfig);

    const content = response.choices[0].message.content;
    console.log("ğŸ“¥ OpenAI response received");
    console.log("Response preview:", content?.substring(0, 200));

    if (!content) {
      throw new Error("OpenAI returned empty response");
    }

    // JSON ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆëŠ”ë° ì‘ë‹µì´ JSONì´ ì•„ë‹Œ ê²½ìš° ê²€ì¦
    if (isProblemSolvingMode) {
      const trimmedContent = content.trim();
      const isJson =
        trimmedContent.startsWith("{") && trimmedContent.endsWith("}");

      if (!isJson) {
        console.error("âŒ JSON ëª¨ë“œì¸ë° JSON í˜•ì‹ì´ ì•„ë‹˜!");
        console.error("ì‘ë‹µ ë‚´ìš©:", content);

        // JSON íŒŒì‹± ì‹œë„
        try {
          JSON.parse(content);
        } catch (e) {
          console.error("JSON íŒŒì‹± ì‹¤íŒ¨:", e);
          // JSONì´ ì•„ë‹ˆë©´ ì—ëŸ¬ ë°˜í™˜
          return NextResponse.json(
            {
              error: "AIê°€ JSON í˜•ì‹ì„ ì§€í‚¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
              rawResponse: content,
            },
            { status: 500 }
          );
        }
      } else {
        console.log("âœ… JSON í˜•ì‹ ê²€ì¦ í†µê³¼");
      }
    }

    return NextResponse.json({
      message: content,
    });
  } catch (error: any) {
    console.error("âŒ Chat API error:", error);

    // OpenAI API ì—ëŸ¬ ì²˜ë¦¬
    if (error.code === "insufficient_quota") {
      return NextResponse.json(
        { error: "OpenAI API í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤." },
        { status: 429 }
      );
    }

    if (error.code === "invalid_api_key") {
      return NextResponse.json(
        { error: "OpenAI API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." },
        { status: 401 }
      );
    }

    return NextResponse.json(
      { error: error.message || "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." },
      { status: 500 }
    );
  }
}
